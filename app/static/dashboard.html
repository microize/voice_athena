<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Golden Interview Platform</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg width='32' height='32' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='16' cy='16' r='16' fill='%232a6ed1'/%3e%3ctext x='16' y='22' text-anchor='middle' font-family='Arial, sans-serif' font-size='20' font-weight='bold' fill='white'%3eA%3c/text%3e%3c/svg%3e">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Fonts imported via global.css -->
    
    <!-- Lucide Icons (Local) -->
    <script src="/static/js/lucide.js"></script>

    <!-- Modular CSS -->
    <link rel="stylesheet" href="/static/styles/global.css">
    <link rel="stylesheet" href="/static/styles/buttons.css">
    <link rel="stylesheet" href="/static/styles/dashboard-glass-fix.css">
    <link rel="stylesheet" href="/static/components/nav-component.css">
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <div id="navigation-container"></div>

        <div class="main-content">
            <!-- Welcome Card with Search Only -->
            <div class="welcome-card">
                <div class="welcome-greeting">
                    <h1 class="greeting-text">Hello, <span id="greetingUserName">User</span></h1>
                </div>
                <div class="welcome-chat">
                    <div class="chat-input-wrapper">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" 
                               id="chatInput" 
                               class="chat-input" 
                               placeholder="Search or ask anything..."
                               maxlength="500">
                        <button id="chatSendBtn" class="chat-send-btn" disabled>
                            <i data-lucide="arrow-right" class="send-icon"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <!-- Left Section (70%) - Problems -->
                <div class="problems-section">
                    <!-- Recently Attempted Problems -->
                    <div class="problem-group">
                        <div class="group-header">
                            <h3 class="group-title">
                                <i data-lucide="clock" class="group-icon"></i>
                                Recently Attempted
                            </h3>
                            <a href="/problems" class="view-all-link">View All</a>
                        </div>
                        <div class="problem-cards" id="recentProblems">
                            <div class="no-problems-card">
                                <i data-lucide="clock" class="no-problems-icon"></i>
                                <span>No recent attempts yet</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bookmarked Problems -->
                    <div class="problem-group">
                        <div class="group-header">
                            <h3 class="group-title">
                                <i data-lucide="bookmark" class="group-icon"></i>
                                Bookmarked Problems
                            </h3>
                            <a href="/problems" class="view-all-link">View All</a>
                        </div>
                        <div class="problem-cards" id="bookmarkedProblems">
                            <div class="no-problems-card">
                                <i data-lucide="bookmark" class="no-problems-icon"></i>
                                <span>No bookmarks yet</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section (30%) - Stats -->
                <div class="stats-section">
                    <!-- Streak Card -->
                    <div class="stat-card streak-card">
                        <div class="stat-header">
                            <div class="stat-icon streak-icon">
                                <i data-lucide="flame" class="icon"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="streakValue">0</div>
                                <div class="stat-label">Day Streak</div>
                            </div>
                        </div>
                        <div class="streak-progress">
                            <div class="streak-bar">
                                <div class="streak-fill" id="streakFill" style="width: 0%"></div>
                            </div>
                            <div class="streak-text">Keep going!</div>
                        </div>
                    </div>

                    <!-- Problems Solved Card -->
                    <div class="stat-card solved-card">
                        <div class="stat-header">
                            <div class="stat-icon solved-icon">
                                <i data-lucide="check-circle" class="icon"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="solvedValue">0</div>
                                <div class="stat-label">Problems Solved</div>
                            </div>
                        </div>
                        <div class="difficulty-breakdown">
                            <div class="difficulty-item">
                                <span class="difficulty-badge easy">Easy</span>
                                <span class="difficulty-count" id="easyCount">0</span>
                            </div>
                            <div class="difficulty-item">
                                <span class="difficulty-badge medium">Medium</span>
                                <span class="difficulty-count" id="mediumCount">0</span>
                            </div>
                            <div class="difficulty-item">
                                <span class="difficulty-badge hard">Hard</span>
                                <span class="difficulty-count" id="hardCount">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Card -->
                    <div class="stat-card performance-card">
                        <div class="stat-header">
                            <div class="stat-icon performance-icon">
                                <i data-lucide="trending-up" class="icon"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="accuracyValue">0%</div>
                                <div class="stat-label">Success Rate</div>
                            </div>
                        </div>
                        <div class="performance-details">
                            <div class="performance-item">
                                <span class="performance-label">This Week</span>
                                <span class="performance-value" id="weeklyPerformance">-</span>
                            </div>
                            <div class="performance-item">
                                <span class="performance-label">Best Streak</span>
                                <span class="performance-value" id="bestStreak">0 days</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modular JavaScript -->
    <script src="/static/components/nav-component.js"></script>
    <script src="/static/js/utils.js"></script>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await loadNavigation({activePage: 'dashboard', rightContent: 'userInfo'});
            
            // Load user info for welcome card
            await loadWelcomeUserInfo();
            
            // Setup chat input functionality
            setupChatInput();
            
            // Load dashboard data
            await loadDashboardData();
        });

        // Load user info for welcome card
        async function loadWelcomeUserInfo() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const data = await response.json();
                    const welcomeUserName = document.getElementById('welcomeUserName');
                    const greetingUserName = document.getElementById('greetingUserName');
                    if (greetingUserName && data.authenticated) {
                        greetingUserName.textContent = data.username || 'User';
                    }
                    if (welcomeUserName && data.authenticated) {
                        welcomeUserName.textContent = data.username || 'User';
                    }
                }
            } catch (error) {
                console.error('Error loading welcome user info:', error);
            }
        }

        // Setup chat input functionality
        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');

            if (chatInput && chatSendBtn) {
                // Enable/disable send button based on input
                chatInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    chatSendBtn.disabled = value.length === 0;
                });

                // Handle send button click
                chatSendBtn.addEventListener('click', function() {
                    const message = chatInput.value.trim();
                    if (message) {
                        handleChatMessage(message);
                        chatInput.value = '';
                        chatSendBtn.disabled = true;
                    }
                });

                // Handle Enter key
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!chatSendBtn.disabled) {
                            chatSendBtn.click();
                        }
                    }
                });
            }
        }

        // Handle chat message
        function handleChatMessage(message) {
            console.log('Chat message:', message);
            // TODO: Implement chat functionality
            // This could connect to an AI assistant or help system
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load problems data
                await loadProblemsData();
                
                // Load stats data
                loadStatsData();
                
                // Re-render lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load problems data
        async function loadProblemsData() {
            // Load recent problems
            const recentProblems = getRecentlyAttemptedProblems();
            renderProblems('recentProblems', recentProblems.slice(0, 2));

            // Load bookmarked problems
            const bookmarkedProblems = getBookmarkedProblems();
            renderProblems('bookmarkedProblems', bookmarkedProblems.slice(0, 2));
        }

        // Get recently attempted problems from localStorage
        function getRecentlyAttemptedProblems() {
            return JSON.parse(localStorage.getItem('recentlyAttempted') || '[]');
        }

        // Get bookmarked problems from localStorage
        function getBookmarkedProblems() {
            return JSON.parse(localStorage.getItem('bookmarkedProblems') || '[]');
        }

        // Render problems in container
        function renderProblems(containerId, problems) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (problems.length === 0) {
                // Keep the default no-problems message
                return;
            }

            // Clear container and add problem cards
            container.innerHTML = problems.map(problem => `
                <div class="problem-card" onclick="window.location.href='/problem/${problem.id}'">
                    <div class="problem-info">
                        <span class="difficulty-badge ${problem.difficulty?.toLowerCase() || 'medium'}">${problem.difficulty || 'Medium'}</span>
                        <a href="/problem/${problem.id}" class="problem-title">${sanitizeInput(problem.title)}</a>
                    </div>
                    <div class="problem-status">${problem.status || (problem.lastAttempted ? formatTimeAgo(problem.lastAttempted) : 'Not attempted')}</div>
                </div>
            `).join('');
        }

        // Load stats data
        function loadStatsData() {
            const stats = getUserStats();
            
            // Update streak
            document.getElementById('streakValue').textContent = stats.currentStreak;
            document.getElementById('streakFill').style.width = `${Math.min((stats.currentStreak / 7) * 100, 100)}%`;
            
            // Update problems solved
            document.getElementById('solvedValue').textContent = stats.totalSolved;
            document.getElementById('easyCount').textContent = stats.easySolved;
            document.getElementById('mediumCount').textContent = stats.mediumSolved;
            document.getElementById('hardCount').textContent = stats.hardSolved;
            
            // Update performance
            document.getElementById('accuracyValue').textContent = `${stats.successRate}%`;
            document.getElementById('weeklyPerformance').textContent = stats.weeklyProblems > 0 ? `${stats.weeklyProblems} solved` : '-';
            document.getElementById('bestStreak').textContent = `${stats.bestStreak} days`;
            
            // Update streak text
            const streakText = document.querySelector('.streak-text');
            if (stats.currentStreak === 0) {
                streakText.textContent = 'Start your streak!';
            } else if (stats.currentStreak < 7) {
                streakText.textContent = `${7 - stats.currentStreak} more for weekly goal!`;
            } else {
                streakText.textContent = 'Amazing streak! 🔥';
            }
        }

        // Get user stats from localStorage and calculate metrics
        function getUserStats() {
            const solved = JSON.parse(localStorage.getItem('solvedProblems') || '[]');
            const attempts = JSON.parse(localStorage.getItem('problemAttempts') || '[]');
            
            // Calculate difficulty breakdown
            const easySolved = solved.filter(p => p.difficulty === 'easy').length;
            const mediumSolved = solved.filter(p => p.difficulty === 'medium').length;
            const hardSolved = solved.filter(p => p.difficulty === 'hard').length;
            
            // Calculate success rate
            const totalAttempts = attempts.length;
            const successRate = totalAttempts > 0 ? Math.round((solved.length / totalAttempts) * 100) : 0;
            
            // Calculate streaks
            const currentStreak = calculateCurrentStreak(solved);
            const bestStreak = calculateBestStreak(solved);
            
            // Calculate weekly performance
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weeklyProblems = solved.filter(p => new Date(p.solvedAt || p.lastAttempted) > oneWeekAgo).length;
            
            return {
                totalSolved: solved.length,
                easySolved,
                mediumSolved,
                hardSolved,
                successRate,
                currentStreak,
                bestStreak,
                weeklyProblems
            };
        }

        // Calculate current streak
        function calculateCurrentStreak(solvedProblems) {
            if (solvedProblems.length === 0) return 0;
            
            // Sort by date (most recent first)
            const sorted = solvedProblems
                .filter(p => p.solvedAt || p.lastAttempted)
                .sort((a, b) => new Date(b.solvedAt || b.lastAttempted) - new Date(a.solvedAt || a.lastAttempted));
            
            if (sorted.length === 0) return 0;
            
            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            for (const problem of sorted) {
                const problemDate = new Date(problem.solvedAt || problem.lastAttempted);
                problemDate.setHours(0, 0, 0, 0);
                
                const daysDiff = Math.floor((currentDate - problemDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === streak) {
                    streak++;
                } else if (daysDiff === streak + 1) {
                    // Allow for yesterday if today hasn't been solved yet
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // Calculate best streak
        function calculateBestStreak(solvedProblems) {
            if (solvedProblems.length === 0) return 0;
            
            // For simplicity, return current streak as best streak
            // In a real app, you'd track this over time
            return Math.max(calculateCurrentStreak(solvedProblems), 0);
        }

        // Format time ago helper
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffInHours = Math.floor((now - past) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Just now';
            if (diffInHours < 24) return `${diffInHours}h ago`;
            if (diffInHours < 168) return `${Math.floor(diffInHours / 24)}d ago`;
            return past.toLocaleDateString();
        }
    </script>
</body>
</html>