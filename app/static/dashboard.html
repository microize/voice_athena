<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Golden Interview Platform</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg width='32' height='32' viewBox='0 0 32 32' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='16' cy='16' r='16' fill='%232a6ed1'/%3e%3ctext x='16' y='22' text-anchor='middle' font-family='Arial, sans-serif' font-size='20' font-weight='bold' fill='white'%3eA%3c/text%3e%3c/svg%3e">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Fonts imported via global.css -->
    
    <!-- Lucide Icons (Local) -->
    <script src="/static/js/lucide.js"></script>

    <!-- Modular CSS -->
    <link rel="stylesheet" href="/static/styles/global.css">
    <link rel="stylesheet" href="/static/styles/buttons.css">
    <link rel="stylesheet" href="/static/styles/dashboard.css">
    <link rel="stylesheet" href="/static/styles/dashboard-glass-fix.css">
    <link rel="stylesheet" href="/static/components/nav-component.css">
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <div id="navigation-container"></div>

        <div class="main-content">
            <!-- Welcome Card with Search Only -->
            <div class="welcome-card">
                <div class="welcome-greeting">
                    <h1 class="greeting-text">Hello, <span id="greetingUserName">User</span></h1>
                </div>
                <div class="welcome-chat">
                    <div class="chat-input-wrapper">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" 
                               id="chatInput" 
                               class="chat-input" 
                               placeholder="Search or ask anything..."
                               maxlength="500">
                        <button id="chatSendBtn" class="chat-send-btn" disabled>
                            <i data-lucide="arrow-right" class="send-icon"></i>
                        </button>
                    </div>
                </div>
            </div>


            <!-- Problems Container with Grid Layout -->
            <div class="problems-container">
                <!-- Bookmarked Problems -->
                <div class="problems-section">
                    <h2 class="section-title">Bookmarked Problems</h2>
                    <div class="problems-feed" id="bookmarkedProblems">
                        <div class="no-problems-message">
                            <i data-lucide="bookmark" class="no-problems-icon"></i>
                            <span>No bookmarked problems yet. Visit the Problems page to bookmark your favorite challenges.</span>
                        </div>
                    </div>
                </div>

                <!-- Recently Attempted Problems -->
                <div class="problems-section">
                    <h2 class="section-title">Recently Attempted Problems</h2>
                    <div class="problems-feed" id="recentProblems">
                        <div class="no-problems-message">
                            <i data-lucide="clock" class="no-problems-icon"></i>
                            <span>No recently attempted problems. Start solving problems to see your progress here.</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modular JavaScript -->
    <script src="/static/components/nav-component.js"></script>
    <script src="/static/js/utils.js"></script>
    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await loadNavigation({activePage: 'dashboard', rightContent: 'userInfo'});
            
            // Load user info for welcome card
            await loadWelcomeUserInfo();
            
            // Setup chat input functionality
            setupChatInput();
            
            // Load problems data
            await loadProblemsData();
        });

        // Load user info for welcome card
        async function loadWelcomeUserInfo() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const data = await response.json();
                    const welcomeUserName = document.getElementById('welcomeUserName');
                    const greetingUserName = document.getElementById('greetingUserName');
                    if (greetingUserName && data.authenticated) {
                        greetingUserName.textContent = data.username || 'User';
                    }
                    if (welcomeUserName && data.authenticated) {
                        welcomeUserName.textContent = data.username || 'User';
                    }
                }
            } catch (error) {
                console.error('Error loading welcome user info:', error);
            }
        }

        // Setup chat input functionality
        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');

            if (chatInput && chatSendBtn) {
                // Enable/disable send button based on input
                chatInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    chatSendBtn.disabled = value.length === 0;
                });

                // Handle send button click
                chatSendBtn.addEventListener('click', function() {
                    const message = chatInput.value.trim();
                    if (message) {
                        handleChatMessage(message);
                        chatInput.value = '';
                        chatSendBtn.disabled = true;
                    }
                });

                // Handle Enter key
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!chatSendBtn.disabled) {
                            chatSendBtn.click();
                        }
                    }
                });
            }
        }

        // Handle chat message
        function handleChatMessage(message) {
            console.log('Chat message:', message);
            // TODO: Implement chat functionality
            // This could connect to an AI assistant or help system
        }

        // Load problems data for bookmarked and recent sections
        async function loadProblemsData() {
            try {
                // Load bookmarked problems
                const bookmarkedProblems = getBookmarkedProblems();
                renderProblems('bookmarkedProblems', bookmarkedProblems, 'bookmark');

                // Load recently attempted problems
                const recentProblems = getRecentlyAttemptedProblems();
                renderProblems('recentProblems', recentProblems, 'clock');
            } catch (error) {
                console.error('Error loading problems data:', error);
            }
        }

        // Get bookmarked problems from localStorage
        function getBookmarkedProblems() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarkedProblems') || '[]');
            return bookmarks.slice(0, 5); // Show max 5 problems
        }

        // Get recently attempted problems from localStorage
        function getRecentlyAttemptedProblems() {
            const recent = JSON.parse(localStorage.getItem('recentlyAttempted') || '[]');
            return recent.slice(0, 5); // Show max 5 problems
        }

        // Render problems in the specified container
        function renderProblems(containerId, problems, fallbackIcon) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (problems.length === 0) {
                // Keep the default no-problems message
                return;
            }

            // Clear the container and add problems
            container.innerHTML = problems.map(problem => `
                <div class="problem-item">
                    <div class="problem-info">
                        <span class="problem-difficulty ${problem.difficulty?.toLowerCase() || 'medium'}">${problem.difficulty || 'Medium'}</span>
                        <a href="/problem/${problem.id}" class="problem-title">${sanitizeInput(problem.title)}</a>
                    </div>
                    <div class="problem-status">${problem.status || (problem.lastAttempted ? formatTimeAgo(problem.lastAttempted) : 'Not attempted')}</div>
                </div>
            `).join('');
        }

        // Format time ago helper
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffInHours = Math.floor((now - past) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Just now';
            if (diffInHours < 24) return `${diffInHours}h ago`;
            if (diffInHours < 168) return `${Math.floor(diffInHours / 24)}d ago`;
            return past.toLocaleDateString();
        }
    </script>
</body>
</html>